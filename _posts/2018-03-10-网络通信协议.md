---
title: 网络通信协议
categories:
- 网络通信协议
tags:
- 网络通信协议
--- 
互联网诞生之初，国外一些主要计算机生产厂家先后推出了各自的网络体系结构，但它们都属于专用的。为使不同计算机厂家的计算机能够互相通信，以便在更大的范围内建立计算机网络，有必要建立一个国际范围的网络体系结构标准。  
ISO（国际标准化组织）于1981年正式推荐了一个网络系统结构----七层参考模型，叫做开放系统互连模型(Open System Interconnection，OSI)。由于这个标准模型的建立，使得各种计算机网络向它靠拢，大大推动了网络通信的发展。
<!-- more -->  

## OSI
OSI包括七层模型，下面以表格的形式简单介绍下：  

|具体七层|数据格式|功能
|:---|:---|:---|
|应用层 |数据Data  |网络服务与使用者应用程序间的一个接口 | 
|表示层  |数据Data  |数据表示、数据安全、数据压缩 | 
|会话层  |数据Data  |会话层连接到传输层的映射；会话连接的流量控制；数据传输；会话连接恢复与释放；会话连接管理、差错控制 |
|传输层  |数据组织成数据段Segment  |用一个寻址机制来标识一个特定的应用程序（端口号） |
|网络层  |分割和重新组合数据包Packet  | 基于网络层地址（IP地址）进行不同网络系统间的路径选择 | 
|数据链路层|将比特信息封装成数据帧Frame|在物理层上建立、撤销、标识逻辑链接和链路复用以及差错校验等功能。通过使用接收系统的硬件地址或物理地址来寻址 |
|物理层 |传输比特（bit）流  | 	建立、维护和取消物理连接 | 
- 应用层的协议有：Telnet、FTP、HTTP、SNMP、DNS等。
- 传输层的协议有：TCP、UDP、SPX等。
- 网络层的协议有：IP、IPX、OSPF等。  

## TCP/IP
TCP/IP协议并不是指TCP协议和IP协议，而是指以TCP协议、IP协议为代表的一系列协议。TCP/IP协议也是基于OSI参考模型，但TCP/IP协议对七层模型进行了简化，主要包括四层结构：应用层、传输层、网络层、网络接口层。
OSI参考模型与TCP/IP协议的对应关系（图片来自网络）： 
 
![TCP/IP](http://justxhk.com/assets/images/TCP_IP.png)
## TCP
特点：面向连接、可靠。TCP的可靠性是由TCP的三次握手与四次挥手实现的。
### TCP的三次握手

三次握手流程：

![TCP/IP](http://justxhk.com/assets/images/tcp_1.jpg)

- 第一次握手：建立连接时，客户端发送SYN包(`SYN=1,seq=x`)到服务器，并进入`SYN-SEND`状态，等待服务器确认。
- 第二次握手：服务器收到SYN包，必须确认客户的SYN（ack=x+1），同时自己也发送一个SYN包（seq=y），即SYN+ACK包（即总发送数据为 `SYN=1,ACK=1,seq=y,ack=x+1`），此时服务器进入`SYN-RECV`状态。
- 第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(`ACK=1,seq=x+1,ack=y+1`)，此包发送完毕，客户端和服务器进入`ESTAB-LISHED`状态，完成三次握手。  

> SYN与ACK为标识位，有0或1两个值。

为什么需要三次握手？**为了防止已失效的连接请求报文段突然又传送到了服务端，从而产生错误**。三次握手是实现TCP可靠性的相对合适的次数，多一次浪费资源，少一次满足不了要求。   
> 看到一个很形象的解释  
打电话：  
A：能听见我说话吗？  
B：能听见。你能听见我说话吗？  
A：能听见。  
然后开始通话。

TCP使用三次握手，和”两军问题“的类似，只是找到了一个比较合适的次数。  
所谓“两军问题”，就是红军想告诉蓝军明天下午一起对敌开火，那么红军会派信使1号跑过去告诉蓝军，蓝军收到消息再派信使2号告诉红军收到，注意，这时蓝军并不知道红军是否收到蓝军的回复。因此需要红军收到回复再派信使3号告诉蓝军收到回复，而此时红军也不知道蓝军是否收到回复，因此蓝军收到信使3号的消息再派信使4号……  
可以看到，由于信息有可能丢失，为了保证信息传达的确定性，我们需要进行很多次传递。互相通信的次数越多，那么这个信息传递到的概率就越大。TCP采用三次握手，就是为了尽可能可靠。  
当然，TCP相对”两军问题“只是类似，实际上TCP信号丢失的可能性比”两军问题“低的多，而且有重试机制，三次握手已经能保证客户端、服务端的正常通信没有问题。再多握手几次也不能保证下次信号就不丢失么，所以三次握手是最合适的。

### TCP的四次握手
四次挥手流程：

![TCP/IP](http://justxhk.com/assets/images/tcp_2.jpg)

- 第一次挥手：客户端发送FIN包(`FIN=1,seq=u`)到服务器，并进入`FIN-WAIT-1`状态，等待服务器响应。
- 第二次挥手：服务器收到FIN包，确认序列号并发送ACK包到服务器（`ACK=1,seq=v,ack=u+1`）。同时服务器进入`CLOSE-WAIT`状态，客户端接受到ACK包后进入`FIN-WAIT-2`状态。
- 第三次挥手：服务器再次发送FIN+ACK包到客户端（`FIN=1,ACK=1,seq=w,ack=u+1`）,并且服务器进入`LAST-ACK`状态。
- 第四次挥手：客户端收到服务器的FIN+ACK包后，发送ACK包到服务器（`ACK=1,seq=u+1,ack=w+1`）,并且客户端进入`TIME-WAIT`状态。此状态会持续2MSL。若没收到服务器的重发请求，则客户端关闭连接。服务器接受到ACK包后关闭连接。  

> MSL是Maximum Segment Lifetime英文的缩写，中文可以译为“报文最大生存时间”。

为什么需要四次挥手？  
如图所示，实际上第二次挥手的时候如果客户端直接关闭连接，如果服务器还有数据要发送给客户端，则会产生错误。所以第二次挥手服务器先告诉客户端收到关闭请求了，然后发送其他未发送数据给客户端，第三次挥手再发送FIN+ACK包给客户端确认关闭。

为什么需要等待2MSL？  
客户端第四次挥手的信息可能丢失，导致服务器没有收到ACK包，然后重发第三次的FIN+ASK包，如果不等待2MSL，则会出现错误。等待2MSL就是为了防止这样的情况发生。

### Wireshark抓包分析
下面我用Wireshark抓包分析下一个HTTP请求的过程
![TCP/IP](http://justxhk.com/assets/images/http_tcp.jpg)
可以看到HTTP的请求流程如下：
1. 客户端根据HTTP请求的URL分析出目标服务器IP地址(DNS)。
2. 客户端发起第一次握手，三次握手成功后建立TCP链接。
3. 客户端分析完整的HTTP请求链接，打包成TCP协议能解析的数据，向服务器发起请求。
4. 服务器与客户端之间传送数据，包括具体的传输数据，以及HTTP响应码等等。
5. 客户端在接受到HTTP响应码后，表示此次请求完成，发送ACK包到服务端。
6. TCP进入Keep-ALive状态。
7. 一段时间后关闭TCP链接。

> TCP Keep-ALive与HTTP Keep-ALive是两个概念，TCP Keep-ALive主要是客户端或服务器意外断电等导致网络中断的时候，释放TCP链接。  
HTTP Keep-ALive是为了让tcp活得更久一点，以便在同一个连接上传送多个HTTP，提高socket的效率。而TCP Keep-ALive是TCP的一种检测TCP连接状况的保鲜机制。
