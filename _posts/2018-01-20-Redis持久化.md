---
title: Redis持久化
categories:
- Redis
tags:
- Redis
- 缓存
---
Redis提供了RDB和AOF两种不同的持久化方式，两种方式各有其优缺点，我们可以选择其中一种，或者两种混合使用。
<!-- more -->  
## RDB
RDB持久化是指在指定的时间间隔内将内存中的数据集快照写入磁盘文件，默认的文件名为dump.rdb。  

RDB持久化的配置非常灵活，你可以在每个小时保存一下过去24小时内的数据,同时每天保存过去30天的数据，也可以选择在n秒内如果超过m个key被修改就自动保存数据。
### RDB 优点
 - RDB持久化配置灵活，你可以自由选择回到某个你备份的某个时间点（AOF也可以通过修改AOF日志文件来实现，但是麻烦）。
 - RDB本质上就是一个二进制文件，相对AOF来说，更适合灾难恢复。
 - 在恢复大的数据时，RDB的速度要优于AOF。
 - RDB保存RDB文件时，父进程只需要fork出一个子进程，接下来工作由子进程完成，父进程不需要做其他IO操作，可以最大化Redis性能。 
  
### RDB 缺点
 - RDB持久化在Redis宕机时，可能会丢失一段时间的数据
 - 当Redis数据较多时，RDB在fork子进程保存数据集耗费的时间比较长，可能会导致无法响应客户端的请求（毫秒级）。  
 
## AOF
AOF持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF命令以redis协议追加保存每次写的操作到文件末尾，Redis还能对AOF文件进行后台重写，使得AOF文件的体积不至于过大（但仍然比RDB文件的体积大）。  

### AOF 优点
- AOF持久化下，可以选择每秒fsync，每次写的时候fsync。主进程会优先处理客户端的请求，Redis宕机最多丢失1S的数据。
- AOF本质上是一个只进行追加的日志文件，该文件符合Redis协议，可以修改去除错误的操作，然后再进行持久化。

### AOF 缺点
- 相同的数据集，AOF文件的体积比RDB大。
- 根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB 。 在一般情况下， 每秒 fsync 的性能依然非常高， 而关闭 fsync 可以让 AOF 的速度和 RDB 一样快， 即使在高负荷之下也是如此。 不过在处理巨大的写入载入时，RDB 可以提供更有保证的最大延迟时间（latency）。

## 结论
AOF持久化设计出来的原因就是为了解决RDB在Redis宕机时，丢失数据过多的问题，但是RDB用来做备份更加方便，而且恢复大数据时的速度也比AOF快。所以可以接受宕机时几分钟的数据丢失可以选择RDB持久化方式，反之最好是RDB持久化和AOF持久化方式混合使用。
